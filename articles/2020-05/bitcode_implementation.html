<!DOCTYPE html>
<html>

  <head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5VLL8HQ');</script>
  <!-- End Google Tag Manager -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5VL9R6T5ZN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-5VL9R6T5ZN');
  </script>

  <!-- encoding -->
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

  <!-- Primary Meta Tags -->
  <title>Bitcode 도입하기 - hcn1519 DEV</title>
  <meta name="author" content="Changnam Hong">
  <meta name="title" content="Bitcode 도입하기 - hcn1519 DEV">
  <meta name="description" content="Bitcode 도입을 위해 알아야 하는 것들에 대해 정리해보았습니다.">
  <meta name="theme-color" content="#f1f3f4" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Bitcode 도입하기">
  <meta property="og:image" content="/public/assets/iOS.png">
  <meta property="og:description" content="Bitcode 도입을 위해 알아야 하는 것들에 대해 정리해보았습니다.">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/sass/blogTheme.scss.css" async>
  <link rel="stylesheet" href="/public/sass/menu.scss.css" async>
  <link rel="stylesheet" href="/public/sass/syntax.scss.css" async>
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/apple-touch-icon-180x180.png" async>
  <link rel="apple-touch-icon-precomposed" sizes="192x192" href="/android-chrome-192x192.png" async>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" async>
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" async>
  <link rel="manifest" href="/site.webmanifest">
  <!-- Fonts -->
  <link rel="preload" href="/public/fonts/Age-Normal.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/public/fonts/Mona-Sans-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/public/fonts/Mona-Sans-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
  <link type="application/atom+xml" rel="alternate" href="https://hcn1519.github.io/feed.xml" title="hcn1519 DEV" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml" async>

</head>


  <body>
      <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5VLL8HQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="wrap">
      <nav class="menu">
  <div class="menu-container">
    <ul class="menu-list">
      <li class="menu-item">
        <a class="menu-link" href="/">Home</a>
      </li>

      
      
        
          
        
      
        
          
        
      
        
          
            <li class="menu-item">
              <a class="menu-link" href="/about">About</a>
            </li>
          
        
      
        
          
            <li class="menu-item">
              <a class="menu-link" href="/archives/">Archives</a>
            </li>
          
        
      
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
      
        
      
        
          
            <li class="menu-item">
              <a class="menu-link" href="/tags/">Tags</a>
            </li>
          
        
      
    </ul>
  </div>

  <a class="menu-toggle">
    <div class="menu-hamburger"></div>
  </a>
</nav>

      <aside class="side-menu-in-desktop">
        <ul class="menu-list">
  <li class="menu-item">
    <a class="menu-link" href="/">Home</a>
  </li>

  
  
    
      
    
  
    
      
    
  
    
      
        <li class="menu-item">
          <a class="menu-link" href="/about">About</a>
        </li>
      
    
  
    
      
        <li class="menu-item">
          <a class="menu-link" href="/archives/">Archives</a>
        </li>
      
    
  
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
  
    
  
    
      
        <li class="menu-item">
          <a class="menu-link" href="/tags/">Tags</a>
        </li>
      
    
  
</ul>
      </aside>
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="" title="Home">HCN</a>
            <span>DEV</span>
            <span class="translation">
              <small>
              
              <a href="/en">Read in English</a>
              
              </small>
            </span>
          </h3>
        </div>
      </div>
      
      <aside class="table-of-contents">
          <h3 id="table-of-contents">Table of Contents</h3>
<ol>
  <li><a href="./bitcode_implementation#about-bitcode">About bitcode</a></li>
  <li><a href="./bitcode_implementation#bitcode-업로드-프로세스">bitcode 업로드 프로세스</a></li>
  <li><a href="./bitcode_implementation#bitcode가-활성화된-앱의-symbolication">bitcode가 활성화된 앱의 Symbolication</a></li>
  <li><a href="./bitcode_implementation#bcsymbolmap">bcsymbolmap</a></li>
  <li><a href="./bitcode_implementation#xcode-build-setting-for-bitcode">Xcode Build Setting for bitcode</a></li>
  <li><a href="./bitcode_implementation#enable_bitcode">ENABLE_BITCODE</a></li>
  <li><a href="./bitcode_implementation#bitcode_generation_mode">BITCODE_GENERATION_MODE</a></li>
  <li><a href="./bitcode_implementation#library의-bitcode-지원">Library의 bitcode 지원</a></li>
  <li><a href="./bitcode_implementation#바이너리의-bitcode-지원-확인하기">바이너리의 bitcode 지원 확인하기</a></li>
  <li><a href="./bitcode_implementation#cocoaPods을-통해-배포되는-라이브러리의-bitcode-지원">CocoaPods을 통해 배포되는 라이브러리의 bitcode 지원</a></li>
</ol>

      </aside>
      
      <div class="container content">
        <div class="post">
  <h2 class="post-title">Bitcode 도입하기</h2>
  <span class="post-date">21 May 2020</span>
  
  <div class="post-image-feature">
    <img class="feature-image" src=
    
    "/public/assets/iOS.png"
    
    alt="Bitcode 도입하기 feature image">

    
  </div><!-- /.image-wrap -->
  

  

  

  
  

        
  
  
  <p>이번 글에서는 bitcode 도입을 위해 필요한 부분을 정리해보았습니다.</p>

<h2 id="about-bitcode">About bitcode</h2>

<h3 id="bitcode-업로드-프로세스">bitcode 업로드 프로세스</h3>

<div class="message">
    Bitcode is an intermediate representation of a compiled program
</div>

<ul>
  <li>bitcode는 앱스토어에서 App Thining을 위해 바이너리 빌드시 포함하는 <a href="https://en.wikipedia.org/wiki/Intermediate_representation">IR</a>입니다. 앱스토어에서는 업로드된 바이너리에 bitcode가 포함되어 있을 경우 앱의 compile과 linking을 다시 수행하여, 디바이스의 아키텍쳐별로 최적화된 바이너리를 새롭게 생성하고 이를 배포합니다.</li>
  <li>앱 사용자는 자신의 디바이스에 맞는 아키텍처에 대한 바이너리만 다운로드 받으면 되므로 bitcode 활성화시 사용자가 다운로드 받는 앱의 용량이 줄어들게 됩니다.</li>
  <li>정리하면 앱 스토어에 바이너리 업로드시 다음의 과정이 수행됩니다.</li>
</ul>

<ol>
  <li>bitcode가 적용된 하나의 바이너리를 앱스토어에 업로드합니다.</li>
  <li>앱 스토어에서 이 바이너리를 다시 컴파일하여 아키텍처별로 바이너리를 생성합니다.(arm64용 바이너리, armv7용 바이너리 등)</li>
  <li>앱 사용자는 각 디바이스의 아키텍처에 맞는 바이너리만 다운로드 합니다.(bitcode 적용 이전에는 바이너리가 나뉘어지지 않고, 한 개(fat binary)만 사용합니다.)</li>
</ol>

<h3 id="bitcode가-활성화된-앱의-symbolication">bitcode가 활성화된 앱의 Symbolication</h3>

<ul>
  <li>앱 스토어에서 다시 컴파일이 발생하는 것은 앱 개발자가 스토어 업로드를 위해 진행하는 아카이빙의 결과물로 나오는 dSYM을 사용할 수 없게 만듭니다. 앱 바이너리와 dSYM은 바이너리에 포함되는 UUID를 기반으로 매칭이 됩니다. 그래서 빌드가 다시 발생하면(설령 수정 사항이 없는 코드라도) 이전 빌드 결과물의 바이너리/dSYM은 이후의 것과 매칭될 수 없습니다. 그래서 아카이빙 과정에서 생성된 dSYM은 스토어 버전의 앱에서 발생하는 Crash Report를 Symbolicate할 수 없습니다.</li>
  <li>따라서, bitcode 활성화 이후에 Third Party Crash 분석 플랫폼에 dSYM 업로드시에는 <strong>반드시</strong> Xcode Organizer나 iTunes Connect에서 파일을 다운로드 받아야 합니다.</li>
</ul>

<h3 id="bcsymbolmap">bcsymbolmap</h3>

<ul>
  <li>아카이빙 진행시 iTunes Connect에 앱의 Symbol을 업로드할지 결정하는 체크 박스가 존재합니다. 이를 비활성화 할 경우 Xcode는 바이너리 업로드 이전에 앱의 dSYM 파일에 포함된 Symbol을 난독화합니다.(<code class="language-plaintext highlighter-rouge">"__hidden#109_"</code>와 같은 형태) 이렇게 난독화된 Symbol은 <code class="language-plaintext highlighter-rouge">.bcsymbolmap</code>이라는 파일을 통해 복호화됩니다. 그래서 bitcode를 지원하는 바이너리의 dSYM 파일은 그에 대응하는 <code class="language-plaintext highlighter-rouge">.bcsymbolmap</code>을 항상 함께 가지고 있습니다.</li>
  <li>Third Party Crash 분석 플랫폼에 dSYM을 업로드할 때, Xcode에서 다운로드 받는 dSYM은 복호화가 되어 있어서 바로 업로드해도 무방합니다. 하지만 iTunes Connect에서 직접 다운로드 받는 dSYM은 복호화를 직접해주어야 합니다.</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcrun dsymutil <span class="nt">-symbol-map</span> &lt;xcarchive 내의 BCSymbolMaps 경로&gt; &lt;다운로드 받은 dSYM 디렉토리 경로&gt;
</code></pre></div></div>

<h2 id="xcode-build-setting-for-bitcode">Xcode Build Setting for bitcode</h2>

<ul>
  <li>Xcode는 바이너리 빌드시 full bitcode를 포함하는 것과 bitcode가 있다는 것을 표시하는 marker를 포함하는 옵션이 존재합니다.</li>
</ul>

<h3 id="enable_bitcode">ENABLE_BITCODE</h3>

<p>ENABLE_BITCODE을 YES로 설정하면 소스코드 빌드/아카이브시 bitcode와 관련된 Flag가 추가됩니다. 이 때, Build Action에서는 <code class="language-plaintext highlighter-rouge">-embed-bitcode-marker</code>가 추가되고, Archive Action에서는 <code class="language-plaintext highlighter-rouge">-embed-bitcode</code>가 추가됩니다. 관련 정보는 실제 빌드/아카이빙 수행시 로그를 확인해보면 알 수 있습니다.</p>

<ul>
  <li>빌드 수행시 로그</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 빌드 로그 발췌
CompileSwift normal arm64 TestObj.swift (in target 'SomProject' from project 'SomProject')
...
/Debug-iphoneos/SomProject.build/Objects-normal/arm64/TestObj.o -embed-bitcode-marker 
...
</code></pre></div></div>

<ul>
  <li>아카이빙 수행시 로그</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 아카이빙 로그 발췌
SwiftCodeGeneration normal arm64 (in target 'SomProject' from project 'SomProject')
...
/Release-iphoneos/SomProject.build/Objects-normal/arm64/TestObj.bc -embed-bitcode -target arm64-apple-ios11.0 -Xllvm -aarch64-use-tbi -O -disable-llvm-optzns -module-name
...
</code></pre></div></div>

<h3 id="bitcode_generation_mode">BITCODE_GENERATION_MODE</h3>

<p>User Defined Settings에 <code class="language-plaintext highlighter-rouge">BITCODE_GENERATION_MODE</code>을 통해서도 <code class="language-plaintext highlighter-rouge">ENABLED_BITCODE</code>와 동일한 효과를 만들어 낼 수 있습니다. 이 때 value로 <code class="language-plaintext highlighter-rouge">maker</code>를 설정할 경우 <code class="language-plaintext highlighter-rouge">embed-bitcode-marker</code>가 컴파일 Flag로 전달되고, <code class="language-plaintext highlighter-rouge">bitcode</code>를 설정할 경우 <code class="language-plaintext highlighter-rouge">embed-bitcode</code>가 전달됩니다. 경우에 따라서 Build Action에서 full bitcode를 사용해야 하는 경우에 해당 설정 값을 변경하여 Build를 진행할 수 있습니다.</p>

<p><img width="484" alt="스크린샷 2020-05-22 오전 12 59 59" src="https://user-images.githubusercontent.com/13018877/82578788-d73b3400-9bc7-11ea-9ff4-953814cbead4.png" /></p>

<blockquote>
  <p>Note: Other C Flag에 직접 <code class="language-plaintext highlighter-rouge">-fembed-bitcode</code>를 추가하여 bitcode를 활성화할 수도 있습니다.</p>
</blockquote>

<h2 id="library의-bitcode-지원">Library의 bitcode 지원</h2>

<ul>
  <li>bitcode의 가장 큰 단점은 사용하고 있는 라이브러리가 하나라도 bitcode를 지원하지 않을 경우, 앱에서는 bitcode를 활성화할 수 없다는 점입니다.</li>
  <li>앱에서 사용하고 있는 라이브러리의 bitcode 관련하여 참고하면 좋은 내용을 정리하면 다음과 같습니다.</li>
</ul>

<h3 id="바이너리의-bitcode-지원-확인하기">바이너리의 bitcode 지원 확인하기</h3>

<ul>
  <li>특정 라이브러리가 bitcode를 지원하는지 확인하기 위해서는 해당 라이브러리의 바이너리가 LLVM Symbol을 포함하고 있는지를 확인하면 됩니다. 다만, 어떤 Symbol을 확인하면 되는지에 대한 여러 <a href="https://stackoverflow.com/a/33105733/5130783">이슈</a>가 존재하여 확인에 혼돈이 오는 경우가 있습니다.</li>
  <li>결론적으로 아래의 명령어를 통해 출력되는 Symbol이 존재한다면 해당 바이너리는 bitcode를 지원하는 것이라고 볼 수 있습니다.</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>otool <span class="nt">-arch</span> arm64 <span class="nt">-l</span> MyFramework/MyFramework | <span class="nb">grep </span>__LLVM
<span class="nv">$ </span>otool <span class="nt">-arch</span> armv7 <span class="nt">-l</span>  myLib.a | <span class="nb">grep </span>__LLVM
</code></pre></div></div>

<h3 id="cocoapods을-통해-배포되는-라이브러리의-bitcode-지원">CocoaPods을 통해 배포되는 라이브러리의 bitcode 지원</h3>

<ul>
  <li>bitcode는 link 과정에서 처리되는 것이 아니라, compile 과정에서 처리됩니다. 그래서 라이브러리의 빌드를 수행할 때, 해당 바이너리가 bitcode 지원을 하는지 안 하는지에 따라 해당 라이브러리의 bitcode 지원 여부가 결정됩니다. 따라서, <strong>빌드된 바이너리로 배포되는 framework/library의 경우, 이전에 bitcode를 지원하지 않았다면, bitcode를 활성화하여 다시 빌드 후 재배포가 필요합니다.</strong></li>
  <li>CocoaPods의 경우 <code class="language-plaintext highlighter-rouge">vendored_framework</code>, 혹은 <code class="language-plaintext highlighter-rouge">vendored_libraries</code> 으로 배포되는 것들이 이에 해당합니다. 이 중 하나의 라이브러리라도 bitcode를 지원하지 않을 경우 라이브러리를 사용하는 앱에서는 bitcode를 사용할 수 없습니다.</li>
  <li>반면, CocoaPods에서 빌드 바이너리 형태로 배포되는 Pod이 아닌 것들은 앱을 빌드할 경우 직접 빌드를 수행합니다. 그래서 앱의 PodFile 혹은 PodSpec에서 <code class="language-plaintext highlighter-rouge">ENABLED_BITCODE</code>를 명시적으로 <code class="language-plaintext highlighter-rouge">NO</code>로 설정하지 않으면 bitcode를 지원합니다.</li>
</ul>

<h1 id="참고자료">참고자료</h1>

<ul>
  <li><a href="https://developer.apple.com/library/archive/technotes/tn2151/_index.html#//apple_ref/doc/uid/DTS40008184-CH1-SYMBOLICATION-BITCODE">Understanding and Analyzing Application Crash Reports - bitcode</a></li>
  <li><a href="https://help.apple.com/xcode/mac/11.0/index.html?localePath=en.lproj#/devbbdc5ce4f">What is app thinning? (iOS, tvOS, watchOS)</a></li>
  <li><a href="https://www.slideshare.net/syoikeda/how-to-handle-bitcode">How to handle bitcode</a></li>
  <li><a href="https://stackoverflow.com/questions/32755775/how-to-check-a-static-library-is-built-contain-bitcode">How to check a static library is built contain bitcode?</a></li>
  <li><a href="https://medium.com/@heitorburger/static-libraries-frameworks-and-bitcode-6d8f784478a9">Static Libraries, Frameworks, and Bitcode</a></li>
  <li><a href="https://forums.developer.apple.com/message/7038#11344">https://forums.developer.apple.com/message/7038#11344</a></li>
  <li><a href="https://www.guardsquare.com/en/blog/enable-bitcode">https://www.guardsquare.com/en/blog/enable-bitcode</a></li>
</ul>


<div class="related">
  
  
  
  
  
  

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    
      
        
        <h2>읽어 볼만한 다른 글</h2>
        
      <ul class="related-posts">
      
        <li>
          <h3>
            <a href="/articles/2020-02/crash_report_symbolication">
              Crash Report Symbolication
              <small>09 Feb 2020</small>
            </a>
            <small> 
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#iOS">
                iOS
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#BuildSystem">
                BuildSystem
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#Symbol">
                Symbol
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#CrashReport">
                CrashReport
              </a>
            </div>
          </small>
          </h3>
        </li>
      </li>
      
      
    

  

    
    

    

    
      
        <li>
          <h3>
            <a href="/articles/2019-11/framework_basic">
              Framework 이해하기
              <small>16 Nov 2019</small>
            </a>
            <small> 
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#iOS">
                iOS
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#BuildSystem">
                BuildSystem
              </a>
            </div>
          </small>
          </h3>
        </li>
      </li>
      
      
    

  

    
    

    

    
      
        <li>
          <h3>
            <a href="/articles/2019-09/dynamic_library">
              Dynamic Library
              <small>06 Sep 2019</small>
            </a>
            <small> 
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#iOS">
                iOS
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#BuildSystem">
                BuildSystem
              </a>
            </div>
          </small>
          </h3>
        </li>
      </li>
      
      
    

  

    
    

    

    
      
        <li>
          <h3>
            <a href="/articles/2019-07/static-library">
              Static Library
              <small>01 Jul 2019</small>
            </a>
            <small> 
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#iOS">
                iOS
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="/tags/#BuildSystem">
                BuildSystem
              </a>
            </div>
          </small>
          </h3>
        </li>
      </li>
      
      
        
  </ul>

  
</div>


<script>
  
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    // dark mode
    
  }
</script>
<script src="https://utteranc.es/client.js"
        repo="hcn1519/hcn1519.github.io"
        issue-term="og:title"
        label="gets Comments 🙌"
        theme=github-dark
        crossorigin="anonymous"
        async>
</script>
<div class="back-home">
    <a href="">< Home</a>
  </div>
</div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/public/js/sidebarHamburger.js"></script>
  </body>
</html>
