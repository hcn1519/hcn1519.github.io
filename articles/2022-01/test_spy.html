<!DOCTYPE html>
<html lang="ko">

  <head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5VLL8HQ');</script>
  <!-- End Google Tag Manager -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5VL9R6T5ZN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-5VL9R6T5ZN');
  </script>

  <!-- encoding -->
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- Primary Meta Tags -->
  <title>Test Spy - hcn1519 Dev Post</title>
  <meta name="author" content="Changnam Hong">
  <meta name="title" content="Test Spy - hcn1519 Dev Post">
  <meta name="description" content="Test Spy의 정의와 사용 방식에 대해 살펴봅니다.">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1d1d1d" media="(prefers-color-scheme: dark)">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Test Spy">
  <meta property="og:image" content="//public/assets/unittest.png">
  <meta property="og:description" content="Test Spy의 정의와 사용 방식에 대해 살펴봅니다.">

  <!-- CSS -->
  <link rel="stylesheet" href="//public/sass/blogTheme.scss.css" async>
  <link rel="stylesheet" href="//public/sass/menu.scss.css" async>
  <link rel="stylesheet" href="//public/sass/syntax.scss.css" async>
  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="57x57" href="//public/favicon/apple-icon-57x57.png" async>
  <link rel="apple-touch-icon" sizes="60x60" href="//public/favicon/apple-icon-60x60.png" async>
  <link rel="apple-touch-icon" sizes="72x72" href="//public/favicon/apple-icon-72x72.png" async>
  <link rel="apple-touch-icon" sizes="76x76" href="//public/favicon/apple-icon-76x76.png" async>
  <link rel="apple-touch-icon" sizes="114x114" href="//public/favicon/apple-icon-114x114.png" async>
  <link rel="apple-touch-icon" sizes="120x120" href="//public/favicon/apple-icon-120x120.png" async>
  <link rel="apple-touch-icon" sizes="144x144" href="//public/favicon/apple-icon-144x144.png" async>
  <link rel="apple-touch-icon" sizes="152x152" href="//public/favicon/apple-icon-152x152.png" async>
  <link rel="apple-touch-icon" sizes="180x180" href="//public/favicon/apple-icon-180x180.png" async>
  <link rel="icon" type="image/png" sizes="192x192"  href="//public/favicon/android-icon-192x192.png" async>
  <link rel="icon" type="image/png" sizes="32x32" href="//public/favicon/favicon-32x32.png" async>
  <link rel="icon" type="image/png" sizes="96x96" href="//public/favicon/favicon-96x96.png" async>
  <link rel="icon" type="image/png" sizes="16x16" href="//public/favicon/favicon-16x16.png" async>
  <link rel="manifest" href="//public/favicon/manifest.json" async>
  
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="hcn1519 Dev Post" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml" async>

</head>


  <body>
      <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5VLL8HQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="wrap">
      <nav class="menu">
  <div class="menu-container">
    <ul class="menu-list">
      <li class="menu-item">
        <a class="menu-link" href="//">Home</a>
      </li>
      

      
      
        
          
        
      
        
          
        
      
        
          
            <li class="menu-item">
              <a class="menu-link" href="/about">About</a>
            </li>
          
        
      
        
          
            <li class="menu-item">
              <a class="menu-link" href="/archives/">Archives</a>
            </li>
          
        
      
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
      
        
      
        
          
            <li class="menu-item">
              <a class="menu-link" href="/tags/">Tags</a>
            </li>
          
        
      
    </ul>
  </div>


  <a class="menu-toggle">
    <div class="menu-hamburger"></div>
  </a>
</nav>

      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://hcn1519.github.io" title="Home">CNH</a>
            <small>Dev Post</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Test Spy</h1>
  <span class="post-date">05 Jan 2022</span>

  
  <div class="post-image-feature">
    <img class="feature-image" src=
    
    "//public/assets/unittest.png"
    
    alt="Test Spy feature image">

    
  </div><!-- /.image-wrap -->
  

  

  

  
  

        
  
  
  <h2 id="table-of-contents">Table of Contents</h2>

<ol>
  <li><a href="./test_spy#1-what-is-spy?">What is Spy?</a></li>
  <li><a href="./test_spy#2-spy를-통한-unittest-수행-과정">Spy를 통한 UnitTest 수행 과정</a></li>
  <li><a href="./test_spy#3-spy를-사용하는-시점">Spy를 사용하는 시점</a>
    <ol>
      <li><a href="./test_spy#3-2-spy와-clean-swift">Spy와 Clean Swift</a></li>
    </ol>
  </li>
</ol>

<blockquote>
  <p>설명에 사용하는 <a href="https://github.com/hcn1519/TestDoublePlayGround">PlayGround</a>를 확인 가능합니다.</p>
</blockquote>

<h2 id="1-what-is-spy">1. What is Spy?</h2>

<p><code class="language-plaintext highlighter-rouge">Spy</code>는 <code class="language-plaintext highlighter-rouge">SUT</code>의 verify 단계에서 <code class="language-plaintext highlighter-rouge">indirect output</code>을 제공하기 위해 사용되는 <code class="language-plaintext highlighter-rouge">Test Double</code>입니다. 객체를 정의하는 개발자는 객체가 오남용되는 것을 방지하기 위해 사용자가 필요한 API만 public API로 제공합니다. 이는 객체의 역할 분배를 적절히 나누기 위해 좋은 방식이지만, 이 객체를 테스트하고 싶을 때에는 불편한 점이 생깁니다. 예를 들어서, public API가 리턴 값을 제공하지 않는다면 해당 API만으로는 동작이 올바른지 판단할 수 없습니다. 또한, API에서 리턴 값을 제공하더라도 이 리턴값이 적절한 과정을 통해서 만들어진 것인지는 확인이 어렵습니다.</p>

<p>이처럼 public API를 통해서 확인하기 어려운 <code class="language-plaintext highlighter-rouge">SUT</code>의 actions들을 <a href="http://xunitpatterns.com/indirect%20output.html">indirect output</a>이라고 부릅니다. <code class="language-plaintext highlighter-rouge">Spy</code>는 (흔히 우리가 생각하는 스파이처럼) 본래의 <code class="language-plaintext highlighter-rouge">SUT</code>는 제공하지 않는 <code class="language-plaintext highlighter-rouge">indirect output</code>을 제공하는 <code class="language-plaintext highlighter-rouge">Test Double</code>입니다. <code class="language-plaintext highlighter-rouge">indirect output</code>은 객체 내부의 private으로 정의된 property 형태 일수도 있고, 어떤 API의 호출 여부에 대한 정보, 혹은 호출 순서에 대한 정보가 되기도 합니다.</p>

<h2 id="2-spy를-통한-unittest-수행-과정">2. Spy를 통한 UnitTest 수행 과정</h2>

<p><code class="language-plaintext highlighter-rouge">Spy</code>는 UnitTest의 setup 단계에서 <code class="language-plaintext highlighter-rouge">SUT</code>의 <code class="language-plaintext highlighter-rouge">DOC</code>를 대체하는 형태로 사용됩니다. Spy는 기존의 <code class="language-plaintext highlighter-rouge">real-DOC</code>의 인터페이스는 그대로 따르도록 구성하고, 여기에 추가적으로 <code class="language-plaintext highlighter-rouge">real-DOC</code>에서는 제공하지 않는 함수 호출 기록, private properties(<code class="language-plaintext highlighter-rouge">indirect output</code>)를 접근할 수 있도록 합니다.(observation point 제공) 이후에 verification 단계에서 테스트 작성자는 <code class="language-plaintext highlighter-rouge">Spy</code>에서 제공하는 <code class="language-plaintext highlighter-rouge">indirect output</code>을 추가적으로 검증하여 <a href="http://xunitpatterns.com/Production%20Bugs.html#Untested%20Requirement">Untested requirement</a>를 최소화합니다.</p>

<p>공항과 비행기와 관련된 예시를 통해서 Spy의 사용성에 대해서 살펴보겠습니다. 공항에 비행기가 들어오고 나가는 기능을 테스트하고 싶을 때, 아래와 같은 형태로 테스트를 수행할 수 있습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testRealDOCFlight</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">flights</span><span class="p">:</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">1</span><span class="p">),</span>
                             <span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">2</span><span class="p">),</span>
                             <span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">3</span><span class="p">),</span>
                             <span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">4</span><span class="p">)]</span>

    <span class="k">var</span> <span class="nv">airPort</span> <span class="o">=</span> <span class="kt">Airport</span><span class="p">(</span><span class="nv">flights</span><span class="p">:</span> <span class="n">flights</span><span class="p">,</span> <span class="nv">controlTower</span><span class="p">:</span> <span class="kt">ControlTower</span><span class="p">())</span>

    <span class="c1">// exercise</span>
    <span class="n">airPort</span><span class="o">.</span><span class="nf">removeFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">airPort</span><span class="o">.</span><span class="nf">addFlights</span><span class="p">([</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">5</span><span class="p">)])</span>

    <span class="c1">// verify</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">airPort</span><span class="o">.</span><span class="n">flights</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">airPort</span><span class="o">.</span><span class="nf">hasFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">airPort</span><span class="o">.</span><span class="nf">hasFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>

    <span class="k">let</span> <span class="nv">removeNotification</span> <span class="o">=</span> <span class="n">airPort</span><span class="o">.</span><span class="n">controlTower</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="n">first</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">removeNotification</span><span class="p">?</span><span class="o">.</span><span class="n">actionCode</span> <span class="o">==</span> <span class="s">"remove(number:)"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<details>
    <summary>상세 코드 보기</summary>


<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">Flight</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">number</span><span class="p">:</span> <span class="kt">Int</span>

    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">FlightManagable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">flights</span><span class="p">:</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">controlTower</span><span class="p">:</span> <span class="kt">FlightReportable</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">removeFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">hasFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">FlightReportable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">notifications</span><span class="p">:</span> <span class="p">[</span><span class="kt">ControlTower</span><span class="o">.</span><span class="kt">Notification</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">report</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">,</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">detail</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?)</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ControlTower</span><span class="p">:</span> <span class="kt">FlightReportable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">struct</span> <span class="kt">Notification</span> <span class="p">{</span>
        <span class="kd">public</span> <span class="k">var</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span>
        <span class="kd">public</span> <span class="k">var</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="kt">String</span>
        <span class="kd">public</span> <span class="k">var</span> <span class="nv">detail</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">notifications</span><span class="p">:</span> <span class="p">[</span><span class="kt">ControlTower</span><span class="o">.</span><span class="kt">Notification</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">notifications</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">report</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">,</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">detail</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">notification</span> <span class="o">=</span> <span class="kt">ControlTower</span><span class="o">.</span><span class="kt">Notification</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="n">actionCode</span><span class="p">,</span> <span class="nv">detail</span><span class="p">:</span> <span class="n">detail</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">Airport</span><span class="p">:</span> <span class="kt">FlightManagable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">flights</span><span class="p">:</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">controlTower</span><span class="p">:</span> <span class="kt">FlightReportable</span>

    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">flights</span><span class="p">:</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">],</span> <span class="nv">controlTower</span><span class="p">:</span> <span class="kt">FlightReportable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span>
        <span class="k">self</span><span class="o">.</span><span class="n">controlTower</span> <span class="o">=</span> <span class="n">controlTower</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">addFlights</span><span class="p">(</span><span class="n">_</span> <span class="nv">flights</span><span class="p">:</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">flights</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">flights</span><span class="p">)</span>
        <span class="n">controlTower</span><span class="o">.</span><span class="nf">report</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">(),</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="s">"add(flights:)"</span><span class="p">,</span> <span class="nv">detail</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">removeFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">filteredFlight</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">number</span> <span class="p">}</span>
        <span class="k">self</span><span class="o">.</span><span class="n">flights</span> <span class="o">=</span> <span class="n">filteredFlight</span>
        <span class="n">controlTower</span><span class="o">.</span><span class="nf">report</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">(),</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="s">"remove(number:)"</span><span class="p">,</span> <span class="nv">detail</span><span class="p">:</span> <span class="n">number</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">hasFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">flights</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">number</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>


</details>

<p>위와 같이 테스트를 수행하게 되면, 최종적으로 <code class="language-plaintext highlighter-rouge">AirPort</code>에 몇 개의 비행기가 있고 <code class="language-plaintext highlighter-rouge">ControlTower</code>에 쌓인 Notification 정보는 확인이 가능합니다. 하지만, 이 상황에서 <code class="language-plaintext highlighter-rouge">AirPort</code>의 상태가 어떤 메소드의 호출들을 통해 구성되었는지를 알 수는 없습니다. 이런 경우 <code class="language-plaintext highlighter-rouge">AirPort</code>가 의존하는 <code class="language-plaintext highlighter-rouge">ControlTower</code>를 <code class="language-plaintext highlighter-rouge">Spy</code>로 교체하여 해당 정보를 확인할 수 있습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ControlTowerSpy</span><span class="p">:</span> <span class="kt">FlightReportable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">notifications</span><span class="p">:</span> <span class="p">[</span><span class="kt">ControlTower</span><span class="o">.</span><span class="kt">Notification</span><span class="p">]</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">numberOfReports</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">notifications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">self</span><span class="o">.</span><span class="n">numberOfReports</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">report</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="kt">Date</span><span class="p">,</span> <span class="nv">actionCode</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">detail</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">notification</span> <span class="o">=</span> <span class="kt">ControlTower</span><span class="o">.</span><span class="kt">Notification</span><span class="p">(</span><span class="nv">date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                                                     <span class="nv">actionCode</span><span class="p">:</span> <span class="n">actionCode</span><span class="p">,</span>
                                                     <span class="nv">detail</span><span class="p">:</span> <span class="n">detail</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">numberOfReports</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>위처럼 <code class="language-plaintext highlighter-rouge">Spy</code> 객체를 정의하게 되면 실제 <code class="language-plaintext highlighter-rouge">ControlTower</code>(<code class="language-plaintext highlighter-rouge">real-DOC</code>)에서는 제공하지 않는 <code class="language-plaintext highlighter-rouge">numberOfReports</code> 정보(<code class="language-plaintext highlighter-rouge">indirect output</code>)를 추가로 기록할 수 있게 되고, 이를 통해 <code class="language-plaintext highlighter-rouge">AirPort</code>의 report가 실제로 2번 호출되었음을 확인할 수 있습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testSpyFlight</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">flights</span><span class="p">:</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">1</span><span class="p">),</span>
                             <span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">2</span><span class="p">),</span>
                             <span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">3</span><span class="p">),</span>
                             <span class="kt">Flight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">4</span><span class="p">)]</span>

    <span class="k">let</span> <span class="nv">controlTowerSpy</span> <span class="o">=</span> <span class="kt">ControlTowerSpy</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">airPort</span> <span class="o">=</span> <span class="kt">Airport</span><span class="p">(</span><span class="nv">flights</span><span class="p">:</span> <span class="n">flights</span><span class="p">,</span> <span class="nv">controlTower</span><span class="p">:</span> <span class="n">controlTowerSpy</span><span class="p">)</span>

    <span class="c1">// exercise</span>
    <span class="n">airPort</span><span class="o">.</span><span class="nf">removeFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">airPort</span><span class="o">.</span><span class="nf">addFlights</span><span class="p">([</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">5</span><span class="p">)])</span>

    <span class="c1">// verify</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">airPort</span><span class="o">.</span><span class="n">flights</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">airPort</span><span class="o">.</span><span class="nf">hasFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">airPort</span><span class="o">.</span><span class="nf">hasFlight</span><span class="p">(</span><span class="nv">number</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>

    <span class="k">let</span> <span class="nv">removeNotification</span> <span class="o">=</span> <span class="n">airPort</span><span class="o">.</span><span class="n">controlTower</span><span class="o">.</span><span class="n">notifications</span><span class="o">.</span><span class="n">first</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">removeNotification</span><span class="p">?</span><span class="o">.</span><span class="n">actionCode</span> <span class="o">==</span> <span class="s">"remove(number:)"</span><span class="p">)</span>

    <span class="c1">// indirect output</span>
    <span class="k">let</span> <span class="nv">spy</span> <span class="o">=</span> <span class="n">airPort</span><span class="o">.</span><span class="n">controlTower</span> <span class="k">as?</span> <span class="kt">ControlTowerSpy</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">spy</span><span class="p">?</span><span class="o">.</span><span class="n">numberOfReports</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="3-spy를-사용하는-시점">3. Spy를 사용하는 시점</h2>

<p><code class="language-plaintext highlighter-rouge">SUT</code>의 Method를 수행하는 과정에서 <a href="https://hcn1519.github.io/articles/2020-05/expression_statement#side-effect">side effect</a>가 발생하였고 이로 인해 <code class="language-plaintext highlighter-rouge">Untested requirement</code>이 생겨날 때 <code class="language-plaintext highlighter-rouge">Spy</code>를 사용합니다. Spy는 <code class="language-plaintext highlighter-rouge">SUT</code>의 동작 과정에서 기록되는 값들의 <code class="language-plaintext highlighter-rouge">observation points</code>로 활용되고, 아래와 같은 경우에 사용하는 것을 고려할 수 있습니다.</p>

<ul>
  <li>SUT의 <code class="language-plaintext highlighter-rouge">indirect output</code>을 verify하는 중간에 SUT의 모든 attributes의 변경을 예측하기 어려울 때</li>
  <li>Assertion이 테스트 도중에 더 잘 보이도록 구성하고 싶고, 이를 Mock의 expectation만으로는 테스트의 의도를 충분히 드러낼 수 없을 때</li>
</ul>

<h3 id="3-2-spy와-clean-swift">3-2. Spy와 Clean Swift</h3>

<p>Clean Swift에서 UseCase를 테스트하는 과정에서 Spy를 사용하면, 테스트를 좀 더 쉽게 작성할 수 있습니다. Clean Swift은 <code class="language-plaintext highlighter-rouge">interactor</code>, <code class="language-plaintext highlighter-rouge">presenter</code>, <code class="language-plaintext highlighter-rouge">viewController</code>가 단방향으로 자신이 의존하는 객체의 메소드를 호출합니다. 그에 따라, 메소드들은 모두 리턴 값이 없고, 의존하는 객체가 존재합니다. 테스트 작성자는 SUT의 메소드 호출 이후 상태를 체크하는 방법 이외에 자신이 의존하는 DOC를 Spy로 변경하고 테스트를 수행하면 테스트 과정에서 좀 더 다양한 정보를 얻을 수 있습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testSpyJsonViewerShowJson</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// setup</span>
    <span class="k">let</span> <span class="nv">interactor</span> <span class="o">=</span> <span class="kt">JsonViewer</span><span class="o">.</span><span class="kt">Interactor</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">presenterSpy</span> <span class="o">=</span> <span class="kt">JsonViewer</span><span class="o">.</span><span class="kt">PresenterSpy</span><span class="p">()</span>
    <span class="n">interactor</span><span class="o">.</span><span class="n">presenter</span> <span class="o">=</span> <span class="n">presenterSpy</span>

    <span class="c1">// exercise</span>
    <span class="k">let</span> <span class="nv">sampleData</span> <span class="o">=</span> <span class="s">"""
    {
        "</span><span class="n">spy</span><span class="s">": true
    }
    """</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>

    <span class="n">interactor</span><span class="o">.</span><span class="nf">showJson</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">sampleData</span><span class="p">))</span>

    <span class="c1">// Verify indirect output</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">presenterSpy</span><span class="o">.</span><span class="n">presentJsonIsCalled</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="n">presenterSpy</span><span class="o">.</span><span class="n">jsonModel</span><span class="p">?</span><span class="o">.</span><span class="n">spy</span> <span class="p">??</span> <span class="kc">false</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="참고자료">참고자료</h1>

<ul>
  <li><a href="https://martinfowler.com/bliki/TestDouble.html">Test Double - Martin Fowler</a></li>
  <li><a href="http://xunitpatterns.com/Test%20Spy.html">Test Spy - xUnitPatterns</a></li>
  <li><a href="http://xunitpatterns.com/indirect%20output.html">indirect output</a></li>
  <li><a href="http://xunitpatterns.com/SUT.html">SUT - System Under Test</a></li>
  <li><a href="http://xunitpatterns.com/DOC.html">DOC - Depended On Component</a></li>
</ul>


<div class="related">
  
  
  
  
  
  

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    
      
        
        <h2>읽어 볼만한 다른 글</h2>
        
      <ul class="related-posts">
      
        <li>
          <h3>
            <a href="//articles/2021-12/test_stub">
              Test Stub
              <small>25 Dec 2021</small>
            </a>
            <small> 
            <div class="tag-chips">
              <a class="tag-link" href="//tags/#UnitTest">
                UnitTest
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="//tags/#TestDouble">
                TestDouble
              </a>
            </div>
          </small>
          </h3>
        </li>
      </li>
      
      
    

  

    
    

    

    
      
        <li>
          <h3>
            <a href="//articles/2021-09/unittest">
              UnitTest 개념 소개
              <small>04 Sep 2021</small>
            </a>
            <small> 
            <div class="tag-chips">
              <a class="tag-link" href="//tags/#UnitTest">
                UnitTest
              </a>
            </div>
           
            <div class="tag-chips">
              <a class="tag-link" href="//tags/#TestDouble">
                TestDouble
              </a>
            </div>
          </small>
          </h3>
        </li>
      </li>
      
      
    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  

    
    

    

    

  
  </ul>

  
</div>


<script>
  
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    // dark mode
    
  }
</script>
<script src="https://utteranc.es/client.js"
        repo="hcn1519/hcn1519.github.io"
        issue-term="og:title"
        label="gets Comments 🙌"
        theme=github-dark
        crossorigin="anonymous"
        async>
</script>

<div class="back-home">
    <a href="http://localhost:4000">< Home</a>
  </div>
</div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//public/js/sidebarHamburger.js"></script>
  </body>
</html>
